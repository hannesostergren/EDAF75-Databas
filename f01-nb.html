<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>f01-nb</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {  background-color: #f8f8f8; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ef2929; } /* Alert */
    code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #c4a000; } /* Attribute */
    code span.bn { color: #0000cf; } /* BaseN */
    code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4e9a06; } /* Char */
    code span.cn { color: #000000; } /* Constant */
    code span.co { color: #8f5902; font-style: italic; } /* Comment */
    code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
    code span.dt { color: #204a87; } /* DataType */
    code span.dv { color: #0000cf; } /* DecVal */
    code span.er { color: #a40000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #0000cf; } /* Float */
    code span.fu { color: #000000; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
    code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
    code span.ot { color: #8f5902; } /* Other */
    code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
    code span.sc { color: #000000; } /* SpecialChar */
    code span.ss { color: #4e9a06; } /* SpecialString */
    code span.st { color: #4e9a06; } /* String */
    code span.va { color: #000000; } /* Variable */
    code span.vs { color: #4e9a06; } /* VerbatimString */
    code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <link rel="stylesheet" href="style.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<!-- # -*- mode: markdown; coding: utf-8; fill-column: 60; org-indent-mode: t; column-number-mode: t; flyspell-mode: t; ispell-local-dictionary: "en"; eval: (visual-on); -*- -->
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<p><link rel="stylesheet" href="style.css"></p>
<h1 id="edaf75-lectures-1-and-2">EDAF75 – lectures 1 and 2</h1>
<p>In the text below there are two kinds of problems:</p>
<ul>
<li><p><strong>Problem:</strong>-marked problems, which I intend to
solve during the lecture. Depending on how fast we progress, I may or
may not have time to solve them all – those of the problems we have to
skip during the lectures are left as exercises (see below), but we can
discuss them during QA sessions.</p></li>
<li><p><strong>Exercise:</strong>-marked problems, which I suggest you
solve yourselves (we can also work on them during the QA
sessions).</p></li>
</ul>
<hr />
<h1 id="index">Index</h1>
<ul>
<li><a href="#Basic-queries">Basic queries</a>
(<code>SELECT-FROM-WHERE</code>, or SFW)</li>
<li><a href="#Set-operations">Set operations</a></li>
<li><a href="#Scalar-functions-and-aggregate-functions">Scalar functions
and aggregate functions</a></li>
<li><a href="#Grouping">Grouping</a> (<code>GROUP BY</code>)</li>
<li><a
href="#Subqueries,-Views-and-Common-Table-Expressions">Subqueries, Views
and Common Table Expressions</a></li>
<li><a href="Exercises-to-prepare-for-lecture-2">Exercises to prepare
for lecture 2</a></li>
<li><a
href="#Redundancy,-and-the-case-for-splitting-up-tables">Redundancy, and
the case for splitting up tables</a></li>
<li><a href="#Joining-tables-together">Joining tables together</a></li>
</ul>
<hr />
<p>This document should be used as a <a
href="https://jupyter.org/"><em>Jupyter notebook</em></a>, it contains
<em>cells</em> in which we can evaluate program code (I assume most of
you have used notebooks before, but I’ll have a QA-session after the
lecture, where you can ask if you have any questions about it).</p>
<p>Jupyter notebooks have built in support for <em>Julia</em>,
<em>Python</em>, and <em>R</em> (hence <em>Ju-Pyt-R</em>), here’s some
Python code:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> hello(name):</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;hello, </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">!&quot;</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    name <span class="op">=</span> <span class="bu">input</span>(<span class="st">&quot;What&#39;s your name: &quot;</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    hello(name)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>main()</span></code></pre></div>
<p>You can run the code snippet above by clicking somewhere in the box,
and press Shift-Enter.</p>
<p>We’re primarily going to run SQL code (see below) in our notebooks,
but I’ll also show you some Python code later on in the course (you
don’t have to learn Python to take the course, though).</p>
<h1 id="introduction-to-relational-databases">Introduction to relational
databases</h1>
<p>If we were to keep track of all Nobel laureates in a Python or Java
program, and didn’t know about relational databases, we would probably
define classes for the laureates, and put them in lists. We could also
define classes for the categories, and have one list for each category,
or have lists with one element per year, and somehow track all laureates
in that year, or use some kind of dictionaries/maps. However we chose to
keep track of the data, some searches, insertions and deletions would be
easy to implement, and some would be cumbersome. We’d also have to be
careful to keep our data consistent.</p>
<p>In this course, we’ll use a technique which may at first seem too
simple to be useful, but which turns out to be <em>incredibly</em>
powerful. We’re going to use <a
href="https://en.wikipedia.org/wiki/Relational_database"><em>relational
databases</em></a>, and we’ll store the data in ‘simple’ <a
href="https://en.wikipedia.org/wiki/Table_(database)"><em>tables</em></a>.
Each table looks like a simple spreadsheet – here is a table with some
Nobel laureates:</p>
<style type="text/css">
.tg  {border-collapse:collapse;border-spacing:0;border-color:#999;margin:0px auto}
.tg td{font-family:Arial, sans-serif;font-size:14px;padding:10px 5px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#444;background-color:#F7FDFA;}
.tg th{font-family:Arial, sans-serif;font-size:14px;font-weight:normal;padding:10px 5px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#999;color:#fff;background-color:#26ADE4;}
.tg .tg-e3zv{font-weight:bold}
.tg .tg-9hbo{font-weight:bold;vertical-align:top}
.tg .tg-yw4l{vertical-align:top}
</style>
<table class="tg">
<tr>
<th class="tg-e3zv">
year
</th>
<th class="tg-9hbo">
category
</th>
<th class="tg-9hbo">
name
</th>
<th class="tg-9hbo">
motivation
</th>
</tr>
<tr>
<td class="tg-yw4l">
2011
</td>
<td class="tg-yw4l">
Literature
</td>
<td class="tg-yw4l">
Tomas Tranströmer
</td>
<td class="tg-yw4l">
…
</td>
</tr>
<tr>
<td class="tg-yw4l">
2011
</td>
<td class="tg-yw4l">
Physics
</td>
<td class="tg-yw4l">
Adam Riess
</td>
<td class="tg-yw4l">
…
</td>
</tr>
<tr>
<td class="tg-yw4l">
2011
</td>
<td class="tg-yw4l">
Chemistry
</td>
<td class="tg-yw4l">
Dan Shechtman
</td>
<td class="tg-yw4l">
…
</td>
</tr>
<tr>
<td class="tg-yw4l">
2011
</td>
<td class="tg-yw4l">
Physiology or Medicine
</td>
<td class="tg-yw4l">
Ralph Steinman
</td>
<td class="tg-yw4l">
…
</td>
</tr>
</table>
<p>A <em>row</em> represents an item, and a <em>column</em> represents a
property of the items.</p>
<p>In the example above, each row describes a Nobel laurate, and for
each laureate, we have columns showing what year the prize was awarded,
in what category, the name of the laureate, and the motivation (not
shown here).</p>
<p>One basic idea of relational databases is that all ‘cells’ in a table
should be simple values (no lists or objects), and that we can use
simple operations from <a
href="https://en.wikipedia.org/wiki/Relational_algebra"><em>relational
algebra</em></a> to get information from it. We do it using a
programming language which is highly specialized for manipulating and
extracting information, it is called <a
href="https://en.wikipedia.org/wiki/SQL">SQL</a>, which is short hand
for <em>Structured Query Language</em>. SQL can be pronounced as either
“S-Q-L”, or “sequel”.</p>
<p>SQL is divided into several sub-languages:</p>
<ul>
<li><p><em>Data Definition Language</em> (<em>DDL</em>): constructs used
to define the tables of a database,</p></li>
<li><p><em>Data Manipulation Language</em> (<em>DML</em>): statements
used to query and manipulate data in a database,</p></li>
<li><p><em>Transaction Control Language</em> (<em>TCL</em>): commands
used to handle transactions (we will return to what a transaction is
later in the course), and</p></li>
<li><p><em>Data Control Language</em> (<em>DCL</em>): commands used to
controll access to our data (we’ll will not deal with them in this
course).</p></li>
</ul>
<p>This week we’ll focus on “Data Manipulation”, i.e., ways to query and
modify our databases – next week we’ll look at how to design and create
our databases, and then use DDL to define our tables.</p>
<p>We’ll begin by discussing the following operations from relational
algebra:</p>
<ul>
<li><p><em>selection</em>: choosing some of the rows of a table</p></li>
<li><p><em>projection</em>: choosing some of the columns of a
table</p></li>
</ul>
<p>We will then see various ways to refine and combine queries.</p>
<h2 id="an-actual-dbms">An actual DBMS</h2>
<p>There are many different Relational Database Management Systems (<a
href="https://en.wikipedia.org/wiki/Relational_database">RDMBS:es</a>)
which implements SQL, some of the most prominent are:</p>
<ul>
<li><a
href="https://en.wikipedia.org/wiki/PostgreSQL">PostgreSQL</a></li>
<li><a href="https://en.wikipedia.org/wiki/MariaDB">MariaDB</a></li>
<li><a href="https://en.wikipedia.org/wiki/MySQL">MySQL</a></li>
<li><a
href="https://en.wikipedia.org/wiki/Oracle_Database">Oracle</a></li>
<li><a
href="https://en.wikipedia.org/wiki/Microsoft_SQL_Server">Microsoft SQL
Server</a></li>
<li><a href="https://en.wikipedia.org/wiki/IBM_Db2_Family">IBM
DD2</a></li>
<li><a href="https://en.wikipedia.org/wiki/SQLite">SQLite</a></li>
</ul>
<p>Most of the systems above are <a
href="https://en.wikipedia.org/wiki/Client%E2%80%93server_model"><em>client-server</em></a>-systems,
i.e., they have one program, a SQL server, which handles the data, and
clients who communicate with the server in various ways. There are
several different kinds of clients:</p>
<ul>
<li><p>We can run an IDE, which allows us to see our tables in a
GUI.</p></li>
<li><p>We can run command line clients (CLI) – they are text based
programs who work like typical REPLs, output will just be text in a
terminal window.</p></li>
<li><p>We can write scripts which we send to the server, often through a
CLI.</p></li>
<li><p>We can run a notebook (such as this one), and have it communicate
with our database.</p></li>
<li><p>We can write code in a general purpose language, and have it
communicate with our database.</p></li>
</ul>
<p>In the course, we’ll try all of these methods to access our
databases.</p>
<p>The RDMBS we’ll use in the course is <a
href="https://en.wikipedia.org/wiki/SQLite">SQLite</a>, which is a
lightweight but still very powerful system – it is <em>by far</em> the
most used RDBMS, and it’s probably already running on all of your phones
and computers (just as an example, if you use Chrome for browsing, your
browsing history is typically saved in a SQL-database file
<code>.config/google-chrome/Default/History</code>, and Mozilla use it
for storing meta-data in Firefox and Thunderbird). It’s actually not a
client/server system (instead it is a library which keeps our databases
in files on our computer) – but in the course, we’ll think of SQLite as
if it were a traditional client/server system, because in many ways, it
behaves as one.</p>
<p>To be able to write SQL queries in this notebook, we first have to
run:</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>load_ext sql</span></code></pre></div>
<p>The zip-archive in which this notebook is distributed has a file
<code>lect01.sqlite</code> which contains all Nobel Laureates since 1901
– to use it in our notebook, we import it with:</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>sql sqlite:<span class="op">///</span>lect01.sqlite</span></code></pre></div>
<p>Now we’re good to go, we just have to prefix our SQL queries with
<code>%sql</code> (one line of SQL) or <code>%%sql</code> (several lines
of SQL, this is the form we will use in most cases).</p>
<h1 id="basic-queries">Basic queries</h1>
<p>A simple <em>SQL query</em> can be written as:</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">&lt;</span>what we<span class="st">&#39;re looking for&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="st">FROM   &lt;what table we&#39;</span>re looking <span class="kw">in</span><span class="op">&gt;</span></span></code></pre></div>
<p>Here <code>SELECT</code> is used to select all rows of a given
table.</p>
<p>If we’re only interesting in some of the rows, and we normally are,
we write:</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">&lt;</span>what we<span class="st">&#39;re looking for&gt;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="st">FROM   &lt;what table we&#39;</span>re looking <span class="kw">in</span><span class="op">&gt;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span>  <span class="op">&lt;</span>what items we<span class="st">&#39;re interested in&gt;</span></span></code></pre></div>
<p>The latter form is so common that it’s got its own acronym: “SFW”
(short for
<code>SELECT</code>-<code>FROM</code>-<code>WHERE</code>).</p>
<p>You can see all versions of the <code>SELECT</code>-statement in
SQLite on their <a
href="https://sqlite.org/lang_select.html">documentation for the
<code>SELECT</code> statement</a> (there are corresponding pages for
other commands).</p>
<p>If we want to see all columns in our rows, we can use</p>
<pre class="text"><code>SELECT *
FROM   &lt;what table we&#39;re looking in&gt;
WHERE  &lt;what items we&#39;re interested in&gt;</code></pre>
<p>This is sometimes considered ‘sloppy’, and we can use a projection
(see above) to get just the columns we’re interested in:</p>
<pre class="text"><code>SELECT &lt;column 1&gt;, &lt;column 2&gt;, ...
FROM   &lt;what table we&#39;re looking in&gt;
WHERE  &lt;what items we&#39;re interested in&gt;</code></pre>
<p>Observe that the selection (what rows we’re interested in) is given
in the <code>WHERE</code> clause, whereas the projection (what columns
we’re interested in) is defined in the <code>SELECT</code> clause (the
naming is somewhat counter-intuitive).</p>
<p>Our Nobel Database contains the following information for each
laureate:</p>
<ul>
<li>the <em>year</em> the prize was awarded</li>
<li>the <em>category</em> (‘chemistry’, ‘literature’, ‘physics’,
‘medicine’)</li>
<li>the <em>name</em></li>
<li>the <em>motivation</em></li>
</ul>
<p>Let’s use the first form above to see all Nobel prizes which has been
handed out:</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p>This is too much to look through, so let’s first limit the output to
10 rows (once again, look at the <a
href="https://sqlite.org/lang_select.html">documentation for
<code>SELECT</code></a>, to see if you can find out how to do it).</p>
<p>If we limit the number of returned rows, it’s often useful to start
listing a number of rows down into the table (otherwise we could only
see the first few rows when we used <code>LIMIT</code>) – we use
<code>OFFSET</code> to do that.</p>
<p>We can also select only those prizes awarded in 2013.</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p>Observe that the query returns a new table, we’ll soon see that we
can use the returned table in other queries.</p>
<p><strong>Problem:</strong> <em>What year did Albert Einstein get his
award, and why?</em></p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p>The names of the columns in the returned table is shown above the
actual output, if we want to rename any of the columns in the returned
table, we can use an <em>alias</em>:</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p><strong>Problem:</strong> <em>Who was awarded the physics prize in
1922?</em></p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<h2 id="set-operations">Set operations</h2>
<p>As was said above, the SQL language is built upon relational algebra,
and sets are a first class citizen of relational algebra, so we can use
set operations such as:</p>
<ul>
<li><em>union</em> (<code>UNION</code>)</li>
<li><em>intersection</em> (<code>INTERSECT</code>)</li>
<li><em>difference</em> (<code>EXCEPT</code>)</li>
</ul>
<p>We can use them to combine the results of two or more queries, <em>if
the queries return tables of the same format</em>.</p>
<p><strong>Problem:</strong> <em>Who were awarded the physics prize in
1922 and 1923?</em> Try to solve this problem in at least three
different ways, and see if you can do it using a set operation (however
clumpsy it might be in this case). You can look at the <a
href="https://sqlite.org/lang_select.html">documentation</a> to get some
inspiration.</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<div class="sourceCode" id="cb14"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<div class="sourceCode" id="cb15"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p>There are often several ways of doing things in SQL, and one of the
main points of using SQL is that the database tries to optimize the
operations it needs to fetch our data (there is some seriously clever
code running behind the scenes).</p>
<p><strong>Problem:</strong> <em>Who has been awarded the prize in
literature since 2010, ordered by name?</em></p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p><strong>Problem:</strong> <em>What year did Winston Churchill win a
prize, and in what category?</em></p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p>Using <code>LIKE</code> in our conditions, we get some rudimentary
form of wildcard matching (some SQL databases allow more advanced
regular expressions, but that’s beyond the scope of this course).</p>
<p>If we want to categorize our output, we can use a <code>CASE</code>
statement, it has the general form:</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">..</span>., </span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>       <span class="cf">CASE</span> </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>           <span class="cf">WHEN</span> <span class="op">..</span>. <span class="cf">THEN</span> <span class="op">..</span>.</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>           <span class="cf">WHEN</span> <span class="op">..</span>. <span class="cf">THEN</span> <span class="op">..</span>.</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>           <span class="cf">ELSE</span> <span class="op">..</span>.</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>       <span class="cf">END</span> <span class="kw">AS</span> <span class="op">&lt;</span>name<span class="op">&gt;</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> <span class="op">..</span>.</span></code></pre></div>
<p><strong>Problem:</strong> <em>Show all laureates in physics with a
name beginning with ‘P’ – if they won the prize before 1970 they’re
ancient, if the won the prize between 1970 and 2000 they’re veterans,
otherwise they’re newbies.</em></p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<h2 id="select-and-select-distinct"><code>SELECT</code> and
<code>SELECT DISTINCT</code></h2>
<p><strong>Problem:</strong> <em>What are the different categories of
Nobel prizes?</em></p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p>Using <code>SELECT DISTINCT</code> we only get unique rows in our
output table (duplicate rows are removed from the result).</p>
<h2 id="scalar-functions-and-aggregate-functions">Scalar functions and
aggregate functions</h2>
<p>There are some functions we can apply to our values, each RDBMS
supplies their own set of functions – you can see some of SQLite’s
functions <a href="https://sqlite.org/lang_corefunc.html">here</a>.</p>
<p><strong>Problem:</strong> <em>What was the initial letters of the
laureates in year 2000?</em> Hint: Use the <a
href="https://sqlite.org/lang_corefunc.html#substr"><code>substr</code></a>
function (and observe that the first character has index 1).</p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p>Here, the number of returned rows is the same as we would have had if
we didn’t apply the function.</p>
<p>An <em>aggregate function</em> can be applied to all rows in a table,
<em>but then returns only one value</em>.</p>
<p>The standard aggregate functions are:</p>
<ul>
<li><code>avg</code>: calculates the average for a given column</li>
<li><code>count</code>: counts the rows in a given table</li>
<li><code>min</code>: gets the minimum value of a given column</li>
<li><code>max</code>: gets the maximum value of a given column</li>
<li><code>sum</code>: calculates the sum of a given column</li>
</ul>
<p>Observe that these are all functions which operates on several
values, but return a single value. You can see a list of al SQLite’s
aggregate functions <a
href="https://sqlite.org/lang_aggfunc.html">here</a>.</p>
<p><strong>Problem:</strong> <em>How many laureates were there in year
2000?</em></p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p><strong>Problem:</strong> <em>How many of the laureates has had a
first name beginning with an ‘A’?</em></p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p><strong>Problem:</strong> <em>What year was the first Nobel prize
awarded?</em></p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p><strong>Exercise:</strong> <em>How many Nobel prizes for chemistry
have been awarded?</em></p>
<div class="sourceCode" id="cb25"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<h1 id="grouping">Grouping</h1>
<p>Using <code>GROUP BY</code> we can handle rows in groups – to
understand how it works, lets first look at the following query:</p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>SELECT    year, category, name</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>FROM      nobel</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>WHERE     year <span class="op">=</span> <span class="dv">2013</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>ORDER BY  category</span></code></pre></div>
<p>Here the rows of each category will end up adjacent to each other,
and using <code>GROUP BY</code> we insert an invisible divider between
the groups, and perform any aggregate function on the whole ‘group’:</p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>SELECT    category, count()</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>FROM      nobel</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>WHERE     year <span class="op">=</span> <span class="dv">2013</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>GROUP BY  category</span></code></pre></div>
<p>So, if we apply an aggregate function, such as <code>count()</code>,
in a table which we have grouped, <em>it will be applied to each
group</em>, not to the whole table. Instead of getting one
<code>count()</code> for the whole table (it would be a single value),
we get one <code>count()</code> for each group (as above).</p>
<p>If we add <code>name</code> in the first line, we get a somewhat
arbitrary result:</p>
<div class="sourceCode" id="cb28"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>SELECT    category, count(), name</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>FROM      nobel</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>WHERE     year <span class="op">=</span> <span class="dv">2013</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>GROUP BY  category</span></code></pre></div>
<p>The category and count is correct, but only one name is shown for
each category.</p>
<p>The ‘problem’ is that we only get one row per group in the output,
and that there may be several laureates in each group – our query will
return one of them in a seemingly haphazard manner. We can concatenate
all names in the group using the <a
href="https://sqlite.org/lang_aggfunc.html#groupconcat"><code>group_concat</code></a>-function:</p>
<div class="sourceCode" id="cb29"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>SELECT    category, count(), group_concat(name)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>FROM      nobel</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>WHERE     year <span class="op">=</span> <span class="dv">2013</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>GROUP BY  category</span></code></pre></div>
<p>There is no problem displaying <code>category</code> in the
<code>SELECT</code>-statement above, we get a value which we know is the
same for each row in the group (by definition, since that’s what we
grouped by).</p>
<p>If we’re only interested in those categories with less than three
laureates, we use <code>HAVING</code> to select only <em>groups</em>
with a given property:</p>
<div class="sourceCode" id="cb30"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>SELECT    category, count(), group_concat(name)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>FROM      nobel</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>WHERE     year <span class="op">=</span> <span class="dv">2013</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>GROUP BY  category</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>HAVING    count() <span class="op">&lt;</span> <span class="dv">3</span></span></code></pre></div>
<p>This corresponds to a <code>WHERE</code> statement, but it applies to
groups, not to individual rows (as <code>WHERE</code> does) – so,
<em><code>WHERE</code> and <code>HAVING</code> have similar effects
(they somehow narrow a search), but they’re absolutely not
interchangable!</em></p>
<p><strong>Important</strong> (and often misunderstood): In the query
above we first have a <code>WHERE</code> statement to select some rows
from the whole table, and then group the resulting selection. <em>Every
time we have both a <code>WHERE</code> and a <code>HAVING</code> in the
same query, we must first use <code>WHERE</code> to select rows we can
group, and then use <code>HAVING</code> to select groups.</em> We can
use <code>WITH</code> statements or subqueries (see below) if we want to
have it the other way around.</p>
<p><strong>Problem:</strong> <em>How many laureates are there in each
category?</em></p>
<div class="sourceCode" id="cb31"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p><strong>Problem:</strong> <em>Which categories have more than 200
laureates?</em></p>
<div class="sourceCode" id="cb32"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p><strong>Exercise:</strong> <em>How many laureates were there each
year between 1920 and 1930?</em></p>
<div class="sourceCode" id="cb33"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p><strong>Exercise:</strong> <em>Which years have seen more than 9
laureates?</em></p>
<div class="sourceCode" id="cb34"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p><strong>Exercise:</strong> <em>Which have been the 20 years with most
laureates?</em> (We don’t need to be precise in case of ties.)</p>
<div class="sourceCode" id="cb35"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<h1 id="quick-intro-to-window-functions">Quick intro to window
functions</h1>
<p>As we saw above, we can treat partitions of our rows as ‘groups’, by
using <code>GROUP BY</code>.</p>
<p>We also saw than when we use an aggregate function on a group, we
collapse whole groups into one row in the output – but sometimes we want
to apply functions within a group of values, <em>and keep each row in
the output</em>.</p>
<p>Above we listed all laureates in 2013, now we want to add one column
to the output: for each laureate, we want to show how many laureates
shared the prize in her or his category.</p>
<p>If we use <code>GROUP BY</code> and the aggregate function
<code>count()</code> on the categories, we would only get one row per
category, and using <code>count()</code> without grouping would collapse
the whole result into just one row:</p>
<div class="sourceCode" id="cb36"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>SELECT    year, category, name, count() AS count      <span class="op">--</span> oh no<span class="op">!</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>FROM      nobel</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>WHERE     year <span class="op">=</span> <span class="dv">2013</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>ORDER BY  category</span></code></pre></div>
<p>Fortunately, SQL has introduced a way to apply functions only over
‘partitions’ of our tables, and keep all rows in the output – using the
reserved word <code>OVER</code> we can introduce a <em>window</em> of
our rows, and apply the function only over this ‘window’:</p>
<div class="sourceCode" id="cb37"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>SELECT    year, category, name, count() OVER (PARTITION by category) AS count</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>FROM      nobel</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>WHERE     year <span class="op">=</span> <span class="dv">2013</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>ORDER BY  category</span></code></pre></div>
<p>We can also give our windows names, using an alias:</p>
<div class="sourceCode" id="cb38"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>SELECT    year, category, name, count() OVER categories AS count</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>FROM      nobel</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>WHERE     year <span class="op">=</span> <span class="dv">2013</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>WINDOW    categories AS (PARTITION by category)</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>ORDER BY  category</span></code></pre></div>
<p>The aliased window definitions must come after any <code>WHERE</code>
and <code>HAVING</code>, and before any <code>ORDER BY</code>.</p>
<p>So, if we use the reserved word <code>OVER</code> after a function,
it will be applied according to a ‘window’ (there is more to it than
this, but this will suffice for now). In the window we can:</p>
<ul>
<li>define a <em>partition</em>, using <code>PARTITION BY</code>,</li>
<li>define an <em>order</em>, using <code>ORDER BY</code>, and</li>
<li>define a <em>range</em>, which we can use to define groups of rows
relative to each other (but we won’t look at ranges in the course).</li>
</ul>
<p>The function will be applied to each partition, in the same way we
applied aggregate functions to groups above, but now we won’t collapse
the partitions. <em>Observe that the partitioning and ordering are based
only on the selection we make (i.e., only those rows which are chosen in
our <code>WHERE</code> clause).</em></p>
<p>We can use our regular aggregate functions as window functions, but
there are also a couple of dedicated window functions, such as (there
are more, but we won’t use them in the course):</p>
<ul>
<li><code>rank()</code>: ranks rows by the order specified in the
window, ties can occur,</li>
<li><code>row_number()</code>: as <code>rank()</code>, but now we avoid
ties, and rank by row number in the output, and</li>
<li><code>percent_rank()</code>: gives a value between 0.0 and 1.0 (so
it’s a bit of a misnomer), giving the row’s relative rank within its
partition.</li>
</ul>
<p>You can find more <a
href="https://sqlite.org/windowfunctions.html">here</a>.</p>
<p>Window functions can be very powerful, but we’ll not delve too deeply
into them in the course – I want you to be aware of them, though!</p>
<p><strong>Problem:</strong> Add one column which ‘ranks’ the laureates
of 2013 in the table above according to the lengths of their names,
within the categories – shorter names should come before longer
names.</p>
<div class="sourceCode" id="cb39"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p><strong>Problem:</strong> For each laureate with the initial A, list
their category, year, name, and ‘freshness’ within that category, i.e.,
the most recent laureate in a category is ranked 1, the second most
recent laureate is ranked 2, etc. The ranks should be confined to
laureates with the initial <code>A</code>.</p>
<div class="sourceCode" id="cb40"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<h1 id="some-exercises">Some exercises</h1>
<p>To spice things up a bit, I’ve included a table with all olympic
games since 1896 – the table <code>olympics</code> contains the
columns:</p>
<ul>
<li><code>year</code></li>
<li><code>city</code></li>
<li><code>country</code></li>
<li><code>continent</code></li>
<li><code>season</code></li>
<li><code>ordinal_number</code></li>
</ul>
<p>If we look carefully at this table, we can find some unnecessary
repetition, we will soon address this problem (but for now, we’ll let it
pass).</p>
<p><strong>Problem:</strong> <em>How many olympic games have each
continent hosted?</em></p>
<div class="sourceCode" id="cb41"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p><strong>Problem:</strong> <em>When was the first olympic games in
each continent?</em></p>
<div class="sourceCode" id="cb42"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p><strong>Problem:</strong> <em>For each olympic game, show how many
olympic games had come before it in its continent</em></p>
<div class="sourceCode" id="cb43"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p><strong>Problem:</strong> <em>Which countries have hosted the summer
olympics more than once?</em></p>
<div class="sourceCode" id="cb44"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p><strong>Exercise:</strong> <em>List the continents in descending
order by the number of times they’ve hosted the summer olympics</em></p>
<div class="sourceCode" id="cb45"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p><strong>Problem:</strong> <em>Show a ‘histogram’ (no actual diagram,
just the counts) over the the initial letter of the names of all Nobel
laureates</em></p>
<div class="sourceCode" id="cb46"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p>We can group by more than one column, by inserting invisible borders
between all combinations of the given column values:</p>
<p><strong>Problem:</strong> <em>Show a ‘histogram’ over the the initial
letter of the names of all Nobel laureates, <strong>for each
category</strong></em></p>
<div class="sourceCode" id="cb47"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p><strong>Problem:</strong> <em>Has anyone won more than one Nobel
prize?</em> We can assume the names of the laureates are unique (so far
they are!).</p>
<div class="sourceCode" id="cb48"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p><strong>Problem:</strong> <em>Has anyone won more than one Nobel
prize in the same category?</em></p>
<div class="sourceCode" id="cb49"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p><strong>Problem:</strong> <em>Has anyone won Nobel prizes in
different categories?</em></p>
<div class="sourceCode" id="cb50"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<h1 id="subqueries-views-and-common-table-expressions">Subqueries, Views
and Common Table Expressions</h1>
<p>As we noted above, the result of a <code>SELECT</code>-statement is
itself a (kind of) table, and we can use such a table inside other
statements.</p>
<p>One useful pattern is:</p>
<div class="sourceCode" id="cb51"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">..</span>.</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span>   <span class="op">..</span>.</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span>  <span class="op">..</span>. <span class="kw">IN</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">SELECT</span> <span class="op">..</span>.</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">FROM</span> <span class="op">..</span>.</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">WHERE</span> <span class="op">..</span>.)</span></code></pre></div>
<p>The second query is called a <em>subquery</em>.</p>
<p>We’ll use a subquery to find all literature laureates who split their
prizes, we begin with a regular query:</p>
<p><strong>Problem:</strong> <em>Which years were the Nobel prize for
literature split?</em></p>
<div class="sourceCode" id="cb52"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>SELECT    year</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>FROM      nobel</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>WHERE     category <span class="op">=</span> <span class="st">&#39;literature&#39;</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>GROUP BY  year</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>HAVING    count() <span class="op">&gt;</span> <span class="dv">1</span></span></code></pre></div>
<p>… and now we use the result of that query to find out what we’re
really looking for:</p>
<p><strong>Problem:</strong> <em>Which literature laureates split their
prizes?</em></p>
<div class="sourceCode" id="cb53"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>SELECT    year, name</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>FROM      nobel</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>WHERE     category <span class="op">=</span> <span class="st">&#39;literature&#39;</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>          AND year IN (</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>              SELECT    year</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>              FROM      nobel</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>              WHERE     category <span class="op">=</span> <span class="st">&#39;literature&#39;</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>              GROUP BY  year</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>              HAVING    count() <span class="op">&gt;</span> <span class="dv">1</span>)</span></code></pre></div>
<p>This can be simplified by using either of two ways to define
‘temporary tables’:</p>
<ul>
<li><em>Views</em>, and</li>
<li><em>Common Table Expressions</em> (a.k.a. a CTEs, or
<code>WITH</code> statements).</li>
</ul>
<p>They are the result of a <code>SELECT</code> statement, so for our
problem above we could have created a view with the
<code>CREATE VIEW</code> statement:</p>
<div class="sourceCode" id="cb54"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>CREATE VIEW shared_literature_prize(year) AS</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  SELECT    year</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>  FROM      nobel</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>  WHERE     category <span class="op">=</span> <span class="st">&#39;literature&#39;</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>  GROUP BY  year</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>  HAVING    count() <span class="op">&gt;</span> <span class="dv">1</span></span></code></pre></div>
<p>We can then use this view as if it was a regular table, in:</p>
<div class="sourceCode" id="cb55"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>SELECT    year, name</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>FROM      nobel</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>WHERE     category <span class="op">=</span> <span class="st">&#39;literature&#39;</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>          AND year IN (</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>              SELECT    year</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>              FROM      shared_literature_prize)</span></code></pre></div>
<p>Since <code>shared_literature_prize</code> has only one column, we
can make the query even simpler (but beware that not all databases
accept this simplification, and it only works in case we have exactly
one column in our view):</p>
<div class="sourceCode" id="cb56"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>SELECT    year, name</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>FROM      nobel</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>WHERE     category <span class="op">=</span> <span class="st">&#39;literature&#39;</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>          AND year IN shared_literature_prize</span></code></pre></div>
<p>A view will stay around until we explicitly drop it:</p>
<div class="sourceCode" id="cb57"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>DROP VIEW shared_literature_prize</span></code></pre></div>
<p>Common table expressions are in many ways similar to views, but they
are sometimes more convenient:</p>
<ul>
<li>they’re defined as part of a <code>SELECT</code> statement (so there
is nothing to drop afterwards),</li>
<li>since they’re part of a <code>SELECT</code> statement, we only need
one statement (which will become useful when we call our database
remotely, we’ll return to that later in the course), and</li>
<li>they can be defined recursively (we’ll return to that later in the
course).</li>
</ul>
<p>Using a CTE, the solution to the problem above becomes:</p>
<div class="sourceCode" id="cb58"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>WITH shared_literature_prize(year) AS (</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  SELECT    year</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  FROM      nobel</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  WHERE     category <span class="op">=</span> <span class="st">&#39;literature&#39;</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>  GROUP BY  year</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>  HAVING    count() <span class="op">&gt;</span> <span class="dv">1</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>WHERE     category <span class="op">=</span> <span class="st">&#39;literature&#39;</span></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>          AND year IN (</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>              SELECT    year</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>              FROM      shared_literature_prize)</span></code></pre></div>
<p>or just (since our CTE has only one column):</p>
<div class="sourceCode" id="cb59"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>WITH shared_literature_prize(year) AS (</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  SELECT    year</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>  FROM      nobel</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>  WHERE     category <span class="op">=</span> <span class="st">&#39;literature&#39;</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>  GROUP BY  year</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>  HAVING    count() <span class="op">&gt;</span> <span class="dv">1</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>WHERE     category <span class="op">=</span> <span class="st">&#39;literature&#39;</span></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>          AND year IN shared_literature_prize</span></code></pre></div>
<p><strong>Exercise:</strong> <em>Show the years and categories for
recurring laureates (i.e., laureates who has won more than once) – use a
CTE to do it.</em></p>
<div class="sourceCode" id="cb60"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p><strong>Exercise:</strong> <em>Who has won the literature prize in a
year when at least one chemistry laureate had a name beginning with
‘L’?</em> First try to solve this with a regular subquery, and then
rewrite it using a CTE.</p>
<div class="sourceCode" id="cb61"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p>We saw above that we can’t have another <code>WHERE</code> after the
<code>HAVING</code> clause:</p>
<div class="sourceCode" id="cb62"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>SELECT    category, count() AS count</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>FROM      nobel</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>WHERE     year <span class="op">=</span> <span class="dv">2013</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>GROUP BY  category</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>HAVING    count() <span class="op">&lt;</span> <span class="dv">3</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>WHERE     count <span class="op">&gt;</span> <span class="dv">1</span>        <span class="op">--</span>   <span class="op">&lt;--</span> <span class="kw">not</span> allowed<span class="op">!</span></span></code></pre></div>
<p>but we can make our ‘grouping query’ into a subquery, and have
another <code>WHERE</code> in the outer query</p>
<div class="sourceCode" id="cb63"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>SELECT category, count</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>FROM (</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>    SELECT    category, count() AS count</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>    FROM      nobel</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>    WHERE     year <span class="op">=</span> <span class="dv">2013</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>    GROUP BY  category</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>    HAVING    count() <span class="op">&lt;</span> <span class="dv">3</span>)</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>WHERE count <span class="op">&gt;</span> <span class="dv">1</span></span></code></pre></div>
<p>A somewhat tidier way of expressing this is to use a
<code>WITH</code>-statement:</p>
<div class="sourceCode" id="cb64"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>WITH category_count(category, count) AS (</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>    SELECT    category, count()</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>    FROM      nobel</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>    WHERE     year <span class="op">=</span> <span class="dv">2013</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>    GROUP BY  category</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>    HAVING    count() <span class="op">&lt;</span> <span class="dv">3</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>SELECT category, count</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>FROM   category_count</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>WHERE  count <span class="op">&gt;</span> <span class="dv">1</span></span></code></pre></div>
<h2 id="correlated-subqueries">Correlated subqueries</h2>
<p>Another form of subquery is:</p>
<div class="sourceCode" id="cb65"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">..</span>.,</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">SELECT</span> <span class="op">..</span>.</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>        <span class="kw">FROM</span> <span class="op">..</span>.</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">WHERE</span> <span class="op">..</span>.)</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span>   <span class="op">..</span>.</span></code></pre></div>
<p>This works if the subquery produces one result, such as when we use
an aggregate function. As an example, solve the following problem:</p>
<p><strong>Problem:</strong> <em>List the names of all laureates who has
the longest name of all laureates in their category (in case of ties,
all should be listed) – order by category.</em></p>
<p>Here we can use a subquery which is ‘run’ for each row in our main
query:</p>
<div class="sourceCode" id="cb66"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>SELECT  category, year, name</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>FROM    nobel AS outer_nobel</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>WHERE   length(name) <span class="op">=</span> (</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>            SELECT <span class="bu">max</span>(length(name))</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>            FROM   nobel</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>            WHERE  category <span class="op">=</span> outer_nobel.category)</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>ORDER BY category</span></code></pre></div>
<p>This is called a <em>correlated subquery</em> (since we refer to the
enclosing query inside it). We use an alias to distinguish between the
nobel table in the outer query and the nobel table in the subquery (it’s
the same table, but we ‘iterate’ through it separately).</p>
<p>BTW, we could have skipped the <code>AS</code> in</p>
<div class="sourceCode" id="cb67"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>.</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span>    nobel <span class="kw">AS</span> outer_nobel</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>.</span></code></pre></div>
<p>and just written:</p>
<div class="sourceCode" id="cb68"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>.</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span>    nobel outer_nobel</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>.</span></code></pre></div>
<p>The general opinion is that we should use <code>AS</code>, as it
makes it more obvious that we’re defining an alias.</p>
<hr>
<h1 id="material-to-prepare-for-lecture-2">Material to prepare for
lecture 2</h1>
<p>Some of the exercises in this section have answers right below them,
try to solve the exercises yourself before looking at the answers.</p>
<p><strong>Exercise:</strong> <em>Write a query to find out who has
shared the chemistry prize with exactly one other laureate in years when
the summer olympics were held in Europe?</em></p>
<div class="sourceCode" id="cb69"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p><strong>Answer:</strong> I’ll solve this exercise during lecture
2.</p>
<p><strong>Exercise:</strong> <em>Above we said that there is some
unnecessary repetition in the olympics database, in what way?</em></p>
<p><strong>Answer:</strong> It is pretty obvious that countries never
change continents (or at least it would literally take <em>eons</em> of
time to do so…), so repeating the fact that France is in Europe several
times …</p>
<div class="sourceCode" id="cb70"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>SELECT    country, continent, season, year, city</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>FROM      olympics</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>WHERE     country <span class="op">=</span> <span class="st">&#39;France&#39;</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>ORDER BY  year</span></code></pre></div>
<p>… is <em>redundant</em>.</p>
<p>And this redundance not only creates unnecessary repetition (and thus
wastes disk space), it also introduces a risk of failures when we want
to modify our table (we’ll return to that later).</p>
<p>The ‘problem’ here is that we always get the same answer when we ask
which continent a given country is in – this is what we will call a
<em>functional dependency</em> when we get back to it in a few weeks
time (when we talk about <em>normalization</em>).</p>
<p>The way we’re going to solve the problem is to remove the continents
from the <code>olympics</code>-table, and introduce another table, a
kind of ‘look-up’-table, to find the continent for each country – we’re
going to do exactly that during this lecture.</p>
<p>There is another potential redundance in our <code>olympics</code>
table – every time the game has taken place in, say, Paris, it has been
in France:</p>
<div class="sourceCode" id="cb71"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>SELECT    city, group_concat(year <span class="op">||</span> <span class="st">&quot;: &quot;</span> <span class="op">||</span> country, <span class="st">&quot;, &quot;</span>)</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>FROM      olympics</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>GROUP BY  city</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>HAVING    count() <span class="op">&gt;</span> <span class="dv">1</span></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>ORDER BY  city</span></code></pre></div>
<p>So, it does look as if we could extract the countries as well, and
put them into a seperate ‘look-up’-table, but if Sarajevo were to hold
the olympics in the future, it wouldn’t be in Yugoslavia anymore, and
Moscow is no longer in the Soviet Union, so just extracting the
countries as we did with continents above would not work. There is a
kind of database called <em>temporal databases</em>, which is designed
to handle cases such as this, but we’ll only briefly touch upon them in
this course.</p>
<p>And there is another, more fundamental reason for keeping both name
and country: the names of cities aren’t globally unique, there is a
Paris in Texas, and a Moscow in Kansas, so the country helps us identify
the cities uniquely (a <em>key</em> is something which lets us identify
values uniquely, we’ll discuss keys next week, and then in week 4, when
we give a more formal definition of the concept).</p>
<p><strong>Exercise:</strong> <em>How could we add information about
birth dates, and birth cities to our Nobel laureates?</em></p>
<p><strong>Answer:</strong> Since each laureate has one birth date, and
one birth city, we can just add two more columns,
<code>birth_date</code> and <code>birth_city</code> to our
<code>nobel</code> table.</p>
<p><strong>Exercise:</strong> <em>How could we add information about
academic affiliations for the Nobel laureates?</em> Some of the
laureates have many affiliations, and some have none – and observe that
the ‘cells’ of our table must only contain simple values, so no lists or
objects. Don’t spend to much time to come up with a solution for this –
we haven’t yet discussed the mechanism we’re going to use to solve it –
but it’s a good thing if you can see the limitations of what we’ve seen
so far.</p>
<p><strong>Answer:</strong> SQL allows us to use the value
<code>NULL</code> when a value is missing, so for laureates without any
affiliation, we can just use <code>NULL</code> (although doing it is
somewhat controversial, and we can define our tables in a way which
prohibits it – more about that later).</p>
<p>But handling laureates with several affiliations is more difficult.
One very primitive way of doing it, would be to add several columns:
<code>affiliation_1</code>, <code>affiliation_2</code>, …, but it’s not
only ugly, it only works if we limit the number of affiliations to a
fixed number.</p>
<p>It turns out we can solve this problem in a manner similar to how we
handled continents above: we can add another table (a ‘look-up’-table),
but this time the look-up table would have all affiliations for each
laureate, so it could have several rows for each laureate.</p>
<hr>
<h1 id="redundancy-and-the-case-for-splitting-up-tables">Redundancy, and
the case for splitting up tables</h1>
<p>The term <a
href="https://en.wikipedia.org/wiki/Redundancy_(linguistics)">redundancy</a>
can be defined in many contexts, in general it refers to information
which is expressed more than once. It is sometimes desirable (the human
body has an enormous amount of redundancy, that’s what enable our bodies
to self-heal), and many systems use redundancies for checks (the
penultimate digit in your social security number is an example).</p>
<p>But for databases, redundancy is often a source of confusion and
errors. So, in this course, we’ll generally try to avoid redundancies
when we design our databases, and we’re going to see two completely
different way of doing it:</p>
<ul>
<li>proper <em>ER-modeling</em> (next week), and</li>
<li><em>normalization</em> (week 4).</li>
</ul>
<p>Our original table of Olympic Games looks like this:</p>
<div class="sourceCode" id="cb72"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>SELECT <span class="op">*</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>FROM   olympics</span></code></pre></div>
<p>We can use SQL to create a much better version of our olympic
database with the following lines:</p>
<div class="sourceCode" id="cb73"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>DROP TABLE IF EXISTS continents<span class="op">;</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>CREATE TABLE continents (</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>  country   TEXT,</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>  continent TEXT NOT NULL,</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>  PRIMARY KEY (country)</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>INSERT OR IGNORE</span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>INTO   continents(country, continent)</span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>SELECT country, continent</span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>FROM   olympics<span class="op">;</span></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>DROP TABLE IF EXISTS better_olympics<span class="op">;</span></span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>CREATE TABLE  better_olympics (</span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a>  year            INT,</span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a>  city            TEXT,</span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>  country         TEXT,</span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a>  season          TEXT,</span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a>  ordinal_number  TEXT,</span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a>  PRIMARY KEY (year, season)</span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span>
<span id="cb73-23"><a href="#cb73-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-24"><a href="#cb73-24" aria-hidden="true" tabindex="-1"></a>INSERT</span>
<span id="cb73-25"><a href="#cb73-25" aria-hidden="true" tabindex="-1"></a>INTO   better_olympics(year, city, country, season, ordinal_number)</span>
<span id="cb73-26"><a href="#cb73-26" aria-hidden="true" tabindex="-1"></a>SELECT year, city, country, season, ordinal_number</span>
<span id="cb73-27"><a href="#cb73-27" aria-hidden="true" tabindex="-1"></a>FROM   olympics<span class="op">;</span></span>
<span id="cb73-28"><a href="#cb73-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-29"><a href="#cb73-29" aria-hidden="true" tabindex="-1"></a>ALTER TABLE olympics</span>
<span id="cb73-30"><a href="#cb73-30" aria-hidden="true" tabindex="-1"></a>RENAME TO   redundant_olympics<span class="op">;</span></span>
<span id="cb73-31"><a href="#cb73-31" aria-hidden="true" tabindex="-1"></a>ALTER TABLE better_olympics</span>
<span id="cb73-32"><a href="#cb73-32" aria-hidden="true" tabindex="-1"></a>RENAME TO   olympics<span class="op">;</span></span></code></pre></div>
<p>Now we don’t have to enter the continent the next time Athens, Paris
or London is awarded the games.</p>
<p>Our two tables look like this:</p>
<div class="sourceCode" id="cb74"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>SELECT <span class="op">*</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>FROM   olympics<span class="op">;</span></span></code></pre></div>
<div class="sourceCode" id="cb75"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>SELECT <span class="op">*</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>FROM   continents<span class="op">;</span></span></code></pre></div>
<p>We’ve avoided some redundancy, but now we need a way to combine the
information in our two tables, and that’s what <em>joins</em> are
for.</p>
<h1 id="joining-tables-together">Joining tables together</h1>
<p>To introduce joining, we’re going to use a classic example: a
database for handling college applications. In it a number of students
applies for various majors at different colleges – we want to keep track
of:</p>
<ul>
<li>student id (similar to stil-id)</li>
<li>student name</li>
<li>student’s grade average (gpa)</li>
<li>the size of the student’s highschool</li>
<li>the names of the colleges</li>
<li>the state for each college</li>
<li>the enrollment for each college</li>
<li>the major applied for</li>
<li>the decision (‘Y’ for accepted, ‘N’ otherwise)</li>
</ul>
<p>One way of doing this would be to use one big table:</p>
<div class="sourceCode" id="cb76"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>SELECT <span class="op">*</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>FROM   big_college</span></code></pre></div>
<p>But, just as with our olympics database above, this would give us a
lot of redundance, so we’d like to split this big table into several
related tables.</p>
<p><strong>Exercise:</strong> In lectures 7 and 8 we’ll discuss the
theory and practice of splitting up tables – for now, suggest tables
which you think would make working with our data easier (don’t look
further down on this page until you’ve at least tried).</p>
<p>
 
</p>
<p>
 
</p>
<p>
 
</p>
<p>
 
</p>
<p>
 
</p>
<p>
 
</p>
<p><strong>Solution:</strong> We can have one table for the
students:</p>
<div class="sourceCode" id="cb77"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>SELECT <span class="op">*</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>FROM   students</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>LIMIT <span class="dv">4</span></span></code></pre></div>
<p>One for the colleges:</p>
<div class="sourceCode" id="cb78"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>SELECT <span class="op">*</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>FROM   colleges</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>LIMIT <span class="dv">4</span></span></code></pre></div>
<p>And one for all collage applications made by the students:</p>
<div class="sourceCode" id="cb79"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>SELECT <span class="op">*</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>FROM   applications</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>LIMIT <span class="dv">4</span></span></code></pre></div>
<p>The <code>applications</code> table uses <code>s_id</code> instead of
<code>s_name</code>, since we could have several students with the same
name (we actually have two ‘Amy’) – <code>s_id</code> is guaranteed to
be unique (we’ll talk <em>much</em> more about uniqueness next
week).</p>
<p>Now assume we want to display all applications, <em>with the names of
the students</em> (not just the student id). We then need a way to
combine information in the <code>applications</code> table with
information in the <code>students</code> table, and we’ll do it with a
<a
href="https://en.wikipedia.org/wiki/Join_(SQL)"><em>join</em></a>.</p>
<p>The SQL standard specifies five different kinds of joins:</p>
<ul>
<li><em>cross join</em></li>
<li><em>inner join</em></li>
<li><em>left outer join</em></li>
<li><em>right outer join</em></li>
<li><em>full outer join</em></li>
</ul>
<h2 id="cross-join">Cross join</h2>
<p>The most primitive of the joins is the cross join – we can write it
as:</p>
<pre><code>SELECT      *
FROM        a 
CROSS JOIN  b</code></pre>
<p>Doing this, we get all combinations of rows from each of table
<code>a</code> and <code>b</code> (a.k.a. the <a
href="https://en.wikipedia.org/wiki/Cartesian_product"><em>Cartesian
product</em></a>) – the rows will contain all attributes from both
tables (unless we make a projection).</p>
<p>If we do it with our <code>applications</code> and
<code>students</code> tables we get:</p>
<div class="sourceCode" id="cb81"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>SELECT      <span class="op">*</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>FROM        applications </span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>CROSS JOIN  students</span></code></pre></div>
<p>The number of rows in this table is the product of the number of rows
in each table, and most of the rows in the combined table are
<em>totally</em> useless, since the <code>s_id</code>’s don’t have
anything to do with each other (e.g., in one line the fact that a
student with <code>s_id</code> 123 has applied to CS at Stanford is
combined with the fact that there is a student Bob with
<code>s_id</code> 234 who has a <code>gpa</code> of 3.6).</p>
<p>The only rows of interest to us are those where the student id from
the <code>applications</code> table is the same as the student id from
the <code>students</code> table, and we can express that as:</p>
<div class="sourceCode" id="cb82"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>SELECT      <span class="op">*</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>FROM        applications </span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>CROSS JOIN  students</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>WHERE       applications.s_id <span class="op">=</span> students.s_id</span></code></pre></div>
<p>or, using aliases, so we don’t have to write long table names:</p>
<div class="sourceCode" id="cb83"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>SELECT      <span class="op">*</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>FROM        applications AS a </span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>CROSS JOIN  students AS s</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>WHERE       a.s_id <span class="op">=</span> s.s_id</span></code></pre></div>
<p>We can clean up the output using a projection:</p>
<div class="sourceCode" id="cb84"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>SELECT      s.s_name, a.c_name, a.major</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>FROM        applications AS a </span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>CROSS JOIN  students AS s</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>WHERE       a.s_id <span class="op">=</span> s.s_id</span></code></pre></div>
<p>or even</p>
<div class="sourceCode" id="cb85"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>SELECT      s_name AS name, c_name AS college, major</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>FROM        applications AS a</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>CROSS JOIN  students AS s</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>WHERE       a.s_id <span class="op">=</span> s.s_id</span></code></pre></div>
<p>(we only need to prefix column names when there would otherwise be an
ambiguity).</p>
<p>There is a shortcut for cross joins, we can just put a comma between
the two tables we want to join:</p>
<div class="sourceCode" id="cb86"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>SELECT s_name AS name, c_name AS college, major</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>FROM   applications, students</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>WHERE  applications.s_id <span class="op">=</span> students.s_id</span></code></pre></div>
<p>This works, but there are <em>much</em> more elegant ways to write
this query.</p>
<h2 id="inner-joins">Inner joins</h2>
<p>An <em>inner join</em> combines two tables into a new table (it’s not
actually saved as a table) – it does this by creating combined rows only
when rows from the two tables ‘match’ each other. In this case it’s the
<code>s_id</code> columns which should match, so we write:</p>
<div class="sourceCode" id="cb87"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>SELECT      s_name AS name, c_name AS college, major</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>FROM        applications</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>INNER JOIN  students</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>ON          applications.s_id <span class="op">=</span> students.s_id</span></code></pre></div>
<p>Logically it can be seen as the equivalent of a cross join and then a
selection, but the database engine normally use algorithms which are
much faster and requires much less memory when we define an inner join.
Once you get used to them, inner joins will feel much better to use than
cross joins (although, in theory, the database should try to optimize
all queries, and <em>might</em> find an efficient way to execute even
cross joins).</p>
<p>Inner joins are the default joins, so we can omit the word
<code>INNER</code>, and just write <code>JOIN</code>:</p>
<div class="sourceCode" id="cb88"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>SELECT  s_name AS name, c_name AS college, major</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>FROM    applications</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>JOIN    students</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>ON      applications.s_id <span class="op">=</span> students.s_id</span></code></pre></div>
<p>The condition on which we join tables is often called the <em>join
predicate</em>, and a join where the join predicate is an equality test,
such as here, is sometimes called an <em>equi-join</em>. There is a
special form of join when the columns we’re comparing in an equi-join
have the same name:</p>
<div class="sourceCode" id="cb89"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>SELECT  s_name AS name, c_name AS college, major</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>FROM    applications</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>JOIN    students</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>USING   (s_id)</span></code></pre></div>
<p>One benefit from using <code>USING</code> is that the columns we join
over will not be duplicated, we get only one of them in the output.</p>
<p>I’d say this is the preferred way of writing this query.</p>
<p>There is an even simpler way to write it, using what’s called a
<em>natural join</em>, but it’s error-prone, and you’re
<em>strongly</em> recommended not to use it. It’s written as:</p>
<div class="sourceCode" id="cb90"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>SELECT        s_name AS name, c_name AS college, major</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>FROM          applications</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>NATURAL JOIN  students</span></code></pre></div>
<p>and it joins the tables using an equi-join for all columns with
coinciding names – <em>this could create big problems if there are
attributes in the tables which just happen to coincide without us
realizing it!</em> If we use the <code>JOIN</code> … <code>USING</code>
instead, we explicitly declare on which attributes to join, so we guard
ourselves against accidental column name collisions.</p>
<p>Observe that we can use selections just as before when we join
tables.</p>
<p><strong>Problem:</strong> <em>Write a SQL query which shows all
applications as above, but only for students applying for CS at
Stanford.</em></p>
<div class="sourceCode" id="cb91"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p><strong>Problem:</strong> <em>Write a SQL query which shows the
average gpa for students who have applied for each college.</em></p>
<p>This time it’s OK to count applicants with several applications
several times (so it becomes some kind of weighed average).</p>
<div class="sourceCode" id="cb92"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p>Using a CTE (<code>WITH</code> statement), we can solve this problem
in a more satisfactory way (not counting grades more than once):</p>
<div class="sourceCode" id="cb93"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p>We can join a table with itself, write a query which finds all pairs
with the same Grade Point Average (GPA):</p>
<p>We can do it either with a cross join:</p>
<div class="sourceCode" id="cb94"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>SELECT s1.s_id, s1.s_name, s1.gpa, s2.s_id, s2.s_name, s2.gpa</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>FROM   students AS s1, students AS s2</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>WHERE  s1.gpa <span class="op">=</span> s2.gpa AND</span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>       s1.s_id <span class="op">&lt;</span> s2.s_id</span></code></pre></div>
<p>or with an inner join:</p>
<div class="sourceCode" id="cb95"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>SELECT s1.s_id, s1.s_name, s2.s_id, s2.s_name, gpa</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>FROM   students AS s1 </span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>JOIN   students AS s2 </span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>USING  (gpa)</span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>WHERE  s1.s_id <span class="op">&lt;</span> s2.s_id</span></code></pre></div>
<p>Joining a table with itself is called a <em>self join</em>.</p>
<p><strong>Exercise:</strong> Show the student names and majors for all
applications to Stanford:</p>
<div class="sourceCode" id="cb96"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p><strong>Exercise:</strong> Show the average <code>size_hs</code> for
applications to the different colleges, order by descending size:</p>
<div class="sourceCode" id="cb97"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p>We can apply joins in several steps, each time combining what we’ve
previously joined with another table (the result of which is a new
table, which can be joined over and over again…).</p>
<p><strong>Exercise:</strong> <em>Show the names of all students who
have applied for a college in California – also show the college and
major.</em></p>
<div class="sourceCode" id="cb98"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p>In lab 1 you’ll get plenty of exercise in joining.</p>
<h3 id="using-ctes-and-inner-joins-to-simplify-queries">Using CTEs and
inner joins to simplify queries</h3>
<p>If we often use some query as part of other queries, we can save it
using a <em>view</em>:</p>
<div class="sourceCode" id="cb99"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>DROP VIEW IF EXISTS application_info<span class="op">;</span></span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>CREATE VIEW application_info(s_id, name, major, college, state) AS</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>  SELECT s_id, s_name, major, c_name, state</span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>  FROM   applications</span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>  JOIN   students</span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>  USING  (s_id)</span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>  JOIN   colleges</span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a>  USING  (c_name)<span class="op">;</span></span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a>SELECT DISTINCT name, state</span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a>FROM   application_info</span>
<span id="cb99-13"><a href="#cb99-13" aria-hidden="true" tabindex="-1"></a>WHERE  s_id IN (<span class="dv">123</span>, <span class="dv">234</span>, <span class="dv">456</span>)<span class="op">;</span></span></code></pre></div>
<p>In lab 1 there are a couple of queries which would be easier to write
if we had one big redundant view of all data – try to define such a view
(once you’ve come up with it, the following queries will be very simple
one-liners).</p>
<p>Using joins we can also sometimes simplify unwieldly solutions with
subqueries. We saw above that we could find all nobel laureates who had
the longest name in each category (possibly tied), using the correlated
subquery:</p>
<div class="sourceCode" id="cb100"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>SELECT  category, year, name</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>FROM    nobel AS outer_nobel</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>WHERE   length(name) <span class="op">=</span> (</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>            SELECT <span class="bu">max</span>(length(name))</span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>            FROM   nobel</span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>            WHERE  category <span class="op">=</span> outer_nobel.category)</span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a>ORDER BY category</span></code></pre></div>
<p>A nicer way of solving this is to first save the length of the
longest name for each subquery in a temporary table, and then join this
table using the category:</p>
<div class="sourceCode" id="cb101"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>WITH max_category_name_length(category, max_name_length) AS (</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>  SELECT   category, <span class="bu">max</span>(length(name))</span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>  FROM     nobel</span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>  GROUP BY category</span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>SELECT year, category, name</span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a>FROM   nobel</span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>JOIN   max_category_name_length</span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>USING  (category)</span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a>WHERE  length(name) <span class="op">=</span> max_name_length</span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>ORDER BY  category, year, name</span></code></pre></div>
<p>In the joined table
(<code>nobel JOIN max_category_name_length</code>), each row will get
the additional <code>max_name_length</code> column, and it’s the max
length for the category of the award the row describes (since we joined
using <code>category</code>).</p>
<h2 id="outer-joins">Outer joins</h2>
<p>An inner join combines rows in different tables <em>when there is a
match in the other table</em>, rows with no corresponding row in the
other table will not turn up in the joined table.</p>
<p>With an <em>outer join</em> we can make sure that every row in one or
both of the tables turn up in the joined table – in case there is no
match, it will be combined with a row containing only <code>NULL</code>
values (<code>NULL</code> is written as <code>None</code> in our
notebooks).</p>
<p>As as example, we’ve seen how to join students and their
applications:</p>
<div class="sourceCode" id="cb102"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p>Now, assume we also want to see those students who haven’t applied,
we can do that using a <em>left outer join</em>:</p>
<div class="sourceCode" id="cb103"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p>We still get the rows we got before, but now we also get rows with
<code>NULL</code>’s in the attributes from the right relation, if there
is no row in the right table which corresponds to a row in the left
table (i.e., the <code>s_id</code> found in the <code>students</code>
table has no match in the <code>applications</code> table – the tuples
on the left are sometimes called <em>dangling tuples</em>).</p>
<p>By the way, we can omit the <code>OUTER</code> keyword:</p>
<div class="sourceCode" id="cb104"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p>There is a ‘natural’ version of outer joins …</p>
<div class="sourceCode" id="cb105"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p>… but for the same reasons as for inner joins, it’s <em>much</em>,
<em>much</em> better to explicitly declare which attribute we’re joining
(using <code>USING</code>).</p>
<p>There is a way to get the same result without inner or outer joins,
but it requires more code:</p>
<div class="sourceCode" id="cb106"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>SELECT      s_name, s.s_id, c_name, major</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>FROM        students s</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>CROSS JOIN  applications a</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>WHERE       s.s_id <span class="op">=</span> a.s_id</span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>UNION</span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>SELECT      s_name, s_id, NULL, NULL</span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>FROM        students</span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>WHERE       s_id NOT IN (SELECT s_id</span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>                         FROM   applications)</span></code></pre></div>
<p>Seing this might help you understand what left outer join actually
returns.</p>
<p>Now, the opposite problem, we want to see applications with no
matching students – of course we could just swap <code>students</code>
and <code>applications</code> in the query above, but we could also use
a <em>right outer join</em>:</p>
<div class="sourceCode" id="cb107"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>SELECT     s_name, s_id, c_name, major</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>FROM       students</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>RIGHT JOIN applications USING (s_id)</span></code></pre></div>
<p>There is also a <em>full outer join</em>, which combines the left-
and the right outer joins:</p>
<div class="sourceCode" id="cb108"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>SELECT    s_name, s_id, c_name, major</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>FROM      students</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>FULL JOIN applications USING (s_id)</span></code></pre></div>
<p>Up until recently, SQLite only supported left outer joins, the other
ones were left out :-), but since 2022 it supports left, right and full
outer joins – not having right outer join wasn’t that much of an issue,
since we can always turn a left outer join into a right outer join by
taking the tables in reverse order. If you run into problems using right
or full outer joins in SQLite, you can either try to update SQLite (to
at least 3.39.0), or just reverse the order of the tables (in case of a
right outer join), or use <code>UNION</code> to combine two outer joins
(in case of a full outer join).</p>
<p><strong>Exercise:</strong> <em>Find all ‘spurious’ applications,
i.e., applications where the student id doesn’t match any student’s
id.</em> Try to solve this exercise in two ways (one using an outer
join, the other using subqueries).</p>
<div class="sourceCode" id="cb109"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<div class="sourceCode" id="cb110"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<h1 id="problemsexercises">Problems/Exercises</h1>
<p><strong>Problem:</strong> <em>How many olympic games have each
continent hosted?</em></p>
<div class="sourceCode" id="cb111"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p><strong>Problem:</strong> <em>Some years no Nobel prize was awarded
in some categories, list all such years/categories (we’ll only deal with
physics, chemistry, medicine and literature, since they’re the only ones
we have in our database…).</em></p>
<p>Hint: To solve this problem we want to keep track of all possible
prizes which could have been awarded, assuming all categories have been
awarded since the outset (and indeed they have). So we want three
things:</p>
<ul>
<li>all years when prizes were awarded (in any category)</li>
<li>all categories (in our database…)</li>
<li>all combinations of years/categories</li>
</ul>
<p>We can use a cross join to get all combinations:</p>
<div class="sourceCode" id="cb112"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p>Once we have all possible combinations, we can use various techniques
to find the missing ones:</p>
<div class="sourceCode" id="cb113"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p>Comment: Recently, SQLite has introduced a function <a
href="https://sqlite.org/series.html"><code>generate_series</code></a>,
which lets us generate a series of values – to generate a list of the
years of ‘potential’ olympic summer games we can write (it was a recent
addition, so it may not work in your notebook):</p>
<div class="sourceCode" id="cb114"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>SELECT  value</span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>FROM    generate_series(<span class="dv">1900</span>, <span class="dv">2000</span>, <span class="dv">4</span>)</span></code></pre></div>
<p>During the world wars, no olympics were organized, so the list isn’t
quite right – in the same manner we could have generated a list of all
potential years for nobel prizes, but for some years during the wars, no
prizes were awarded (not for the lack of worthy recipients).</p>
<p><strong>Problem:</strong> <em>List the three programs (college/major)
which has the highest gpa for the “last accepted” student.</em>
(Assuming the students are accepted in order of decreasing gpa).</p>
<div class="sourceCode" id="cb115"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p><strong>Exercise:</strong> <em>When was the first and the latest
olympic games in each continent?</em></p>
<div class="sourceCode" id="cb116"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p><strong>Exercise:</strong> <em>Generate the unwieldly college
application table we started out with above from the three smaller
tables.</em></p>
<div class="sourceCode" id="cb117"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<p><strong>Exercise:</strong> <em>Recreate the original
<code>olympics</code> table from the improved <code>olympics</code> and
<code>continents</code>.</em></p>
<div class="sourceCode" id="cb118"><pre
class="sourceCode python input"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>sql</span></code></pre></div>
<h1 id="instead-of-lists">Instead of lists</h1>
<p>One of the ‘rules’ of relational databases is that the values in our
tables must be primitive, we’re not allowed to have lists or objects as
values. This requirement is called the <a
href="https://en.wikipedia.org/wiki/First_normal_form">“First normal
form”</a>, or “1NF” – we’ll return to ‘normal forms’ during lectures 7
and 8.</p>
<p>If we were to write a program to keep track of the phone numbers of
our friends, we could write something like this in Java:</p>
<div class="sourceCode" id="cb119"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Friend <span class="op">{</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> name<span class="op">;</span></span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">List</span><span class="op">&lt;</span>PhoneNumber<span class="op">&gt;</span> phoneNumbers<span class="op">;</span></span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">...</span></span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a><span class="bu">List</span><span class="op">&lt;</span>Friend<span class="op">&gt;</span> friends <span class="op">=</span> <span class="kw">...</span></span></code></pre></div>
<p>A literal translation of this into a table would be something
like:</p>
<pre><code>name      phone_numbers
----      -------------
Adam      [123456, 654321]
Bodil     [196811]</code></pre>
<p>but this is in violation of the ‘First normal form’, so instead we
have a new row for each phone number:</p>
<pre><code>name      phone
----      -----
Adam      123456
Adam      654321
Bodil     196811</code></pre>
<p>We can ask for Adam’s number with:</p>
<div class="sourceCode" id="cb122"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> phone</span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span>   friends</span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span>  name <span class="op">=</span> <span class="st">&#39;Adam&#39;</span></span></code></pre></div>
<p>and we’d get both numbers back:</p>
<pre><code>phone
-----
123456
654321</code></pre>
<p>Now, assume we also want to save the birthdays of our friends. We
could add a column for birthdays like this:</p>
<pre><code>name    birthday    phone
----    --------    -----
Adam    2 dec       123456
Adam    2 dec       654321
Bodil   30 nov      196811</code></pre>
<p>What’s the problem with this?</p>
<p>And what if we also want to save our friends’ email addresses:</p>
<pre><code>name        birthday    phone       email
----        --------    -----       -----
Adam        2 dec       123456      adam@gmail.com
Adam        2 dec       123456      adam@yahoo.com
Adam        2 dec       654321      adam@gmail.com
Adam        2 dec       654321      adam@yahoo.com
Bodil       30 nov      196811      bodil@itu.dk
Bodil       30 nov      196811      bodil@lu.se
Cecilia     9 apr       511235      cecilia@dn.se
Cecilia     9 apr       641587      cecilia@dn.se
David       12 jun      984531      david@gmail.co
David       12 jun      984531      david@hotmail
Emma        11 aug      123456      emma@lu.se</code></pre>
<p>It may seem silly to have four rows for Adam, but if we removed one
of them, we would loose vital information. If we removed the first row,
and someone asked who had the phone number 123456 <em>and</em> the email
address adam@gmail.com, the query:</p>
<div class="sourceCode" id="cb126"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span>  name, birthday</span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span>    friends</span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span>   phone <span class="op">=</span> <span class="st">&#39;123456&#39;</span> <span class="kw">AND</span> email <span class="op">=</span> <span class="st">&#39;adam@gmail.com&#39;</span></span></code></pre></div>
<p>would give an empty result.</p>
<p>The problem with the table above is that we have a lot of redundance,
i.e., information is repeated in many places. This is not only a waste
of storage space, it also makes it much, much harder to keep our tables
up to date – insertions, updates and removals affects many rows, and if
we’re not careful, we might leave the table in a corrupted state.</p>
<p><strong>Exercise:</strong> <em>The data in the table above would be
much easier to maintain if we split it into several tables – suggest how
to do that.</em></p>
</body>
</html>
